---
title: "Clean code for scraped data of refrigerators"
output:
  html_document:
    df_print: clean_file
  html_notebook: clean_file
  pdf_document: clean_file
author: "Attila Gulyás"
---

I this file I do cleaning in 3 steps. 

1) First, restructure raw files and rename columns with unified English names.
I merge the 2 dataframes into one. I filter the unrelevant attributes out.

2) Second, I do some simple data cleaning with the help of OpenRefine.

3) Finally, I do further data cleaning with R.


#####################
1. Data Cleaning with R, restructure and rename columns
#####################
```{r}

# clear memory
rm(list=ls())

# set working directory
dir <- "C:/Users/gat/OneDrive – Central European University/Data_architecture/Home_work_data_product/"

data_in <- paste0(dir, "raw/")
data_out <-paste0(dir, "clean/")

# Read libraries
library(tidyverse)     # General purpose data wrangling
library(data.table)
library(dplyr)
library(rrefine) # google OpenRefine
library(readr) # for tsv

```

Read raw tables
```{r}
dt_mediamarkt <- read_tsv(paste0(data_in, 'mediamarkt_refrigerator.tsv'))
dt_edigital <- read_tsv(paste0(data_in, 'edigital_refrigerator.tsv'))

dt_mediamarkt <- as.data.table(dt_mediamarkt)
dt_edigital <- as.data.table(dt_edigital)
```

```{r}
# Unique attrubites
attribute_list_mediamarkt <- unique(dt_mediamarkt$item_attribute_name)
attribute_list_edigital <- unique(dt_edigital$item_attribute_name)

```

Select main attributes
```{r}
attribute_list_edigital
#attribute_list_mediamarkt
attribute_selected_edigital <- c("Cikkszám",
                                 "Gyártó",
                                 "Típus",
                                 "Energiaosztály",
                                 "Energiafogyasztás (kWh)",
                                 "Garancia",
                                 "Szín",
                                 "Szélesség (cm)",
                                 "Magasság (cm)",
                                 "Mélység (cm)",
                                 "Súly (kg)",
                                 "Ajtók száma",
                                 "Hűtő űrtartalom",
                                 "Fagyasztó űrtartalom"
                                  )
```

```{r}
attribute_list_mediamarkt
#attribute_list_mediamarkt
attribute_selected_mediamarkt <- c("Cikkszám:",
                                 "Gyártó:",
                                 "Készülék típusa:",
                                 "Energiaosztály:",
                                 "Éves energiafogyasztás:",
                                 "Gyártói garancia hossza (hónap):",
                                 "Szín:",
                                 "Szélesség:",
                                 "Magasság:",
                                 "Mélység:",
                                 "Tömeg:",
                                 "Ajtók száma:",
                                 "Nettó hűtő űrtartalom:",
                                 "Nettó fagyasztó űrtartalom:"
                                  )
```

Keep only the main feautures
```{r}
dt_edigital2 <- dt_edigital[item_attribute_name %in% attribute_selected_edigital,]
dt_mediamarkt2 <- dt_mediamarkt[item_attribute_name %in% attribute_selected_mediamarkt,]
```


Restructure tables
```{r}
dt_edigital3 <- dt_edigital2 %>% spread("item_attribute_name", "item_attribute")
dt_mediamarkt3 <- dt_mediamarkt2 %>% spread("item_attribute_name", "item_attribute")
```


Rename variables to unified English names & merge tables
```{r}
# Sort variables
dt_edigital3 <- dt_edigital3 %>% select(
                            "item_name",
                            "item_price",
                            "website_category",
                            "link",
                            attribute_selected_edigital
                            )

# Rename variables
colnames(dt_edigital3) <- c("item_name",
                            
                            # website specific attributes
                            "item_price_edigital",
                            "website_category_edigital",
                            "link_edigital",
                            "articleID_edigital",
                            
                            #technical attributes
                            "producer",
                            "type",
                            "energy_class",
                            "energy_consumption",
                            "guarantee_month",
                            "colour",
                            "width_cm",
                            "height_cm",
                            "depth_cm",
                            "weight_kg",
                            "n_doors",
                            "cooling_capacity_l",
                            "freezing_capacity_l"
                            )

# Sort variables
dt_mediamarkt3 <- dt_mediamarkt3 %>% select(
                            "item_name",
                            "item_price",
                            "website_category",
                            "link",
                            attribute_selected_mediamarkt
                            )

# Rename variables
colnames(dt_mediamarkt3) <- c("item_name",
                            
                            # website specific attributes
                            "item_price_mediamarkt",
                            "website_category_mediamarkt",
                            "link_mediamarkt",
                            "articleID_mediamarkt",
                            
                            #technical attributes
                            "producer",
                            "type",
                            "energy_class",
                            "energy_consumption",
                            "guarantee_month",
                            "colour",
                            "width_cm",
                            "height_cm",
                            "depth_cm",
                            "weight_kg",
                            "n_doors",
                            "cooling_capacity_l",
                            "freezing_capacity_l"
                            )

# Merge tables
dt_refrigerator <- merge(dt_edigital3, dt_mediamarkt3, all = TRUE)

colnames(dt_refrigerator) 
```

#####################
2. Data Cleaning with OpenRefiner
#####################
```{r}
# Save merged file to the folder
write_tsv(dt_refrigerator, path = paste0(data_out,"dt_refrigerator_raw.tsv"))

# Drop objects
rm(dt_refrigerator)
rm(dt_edigital)
rm(dt_edigital2)
rm(dt_edigital3)
rm(dt_mediamarkt)
rm(dt_mediamarkt2)
rm(dt_mediamarkt3)
rm(attribute_list_edigital)
rm(attribute_list_mediamarkt)
rm(attribute_selected_edigital)
rm(attribute_selected_mediamarkt)

```

Clean table with OpenRefine:
- producer (there was only one producer needed to be merged)
- type (merge same category names)
- colour (merge same colours)
- energy_class (merge same class in one case)

I found that it is not efficient to merge by item_names, because in many cases names are pretty similar, there is only 1 letter difference, but that difference is meaningful).
So, it is better to merge items by technical attributes.


#####################
3. Further data Cleaning with R
#####################
```{r}

# Read table
dt_refrigerator <- read_tsv(paste0(data_out, 'dt_refrigerator_openrefiner.tsv')) %>% as.data.table()
```


Correct values: producer
#####################

```{r}
# Check unique values
dt_refrigerator$producer %>% unique()

# OK
```


Correct values: type
#####################

There are so may types of refrigerators, but the main categories can be the next ones:
1) Refrigerator, 2) Freezer 3) Wine refrigerator 4) Other
```{r}
# Check unique values
dt_refrigerator$type %>% unique()

```

```{r}
# Modify values

dt_refrigerator[type == "Kombinált hűtőszekrény" |
                type == "Alulfagyasztós kombinált hűtőszekrény" |
                type == "Felülfagyasztós kombinált hűtőszekrény" |
                type == "Hűtőszekrény" |
                type == "Egyajtós hűtőszekrény" |
                type == "No Frost kombinált hűtőszekrény" |
                type == "hűtőszekrény, Kombinált hűtő-fagyasztó" |
                type == "Kombinált hűtő-fagyasztó, alulfagyasztós" |
                type == "Minibár hűtőszekrény" |
                type == "Side by side hűtőszekrény", 
                "type"] <- "Refrigerator"

dt_refrigerator[type == "Fagyasztószekrény" |
                type == "Fagyasztóláda", 
                "type"] <- "Freezer"

dt_refrigerator[type == "Borhűtő", "type"] <- "Wine refrigerator"

dt_refrigerator[type == "NA" |
                is.na(type) == TRUE |  
                type == "Elektromos hűtőláda" |
                type == "Hűtőtáska",
                "type"] <- "Other"

# Check unique values
dt_refrigerator$type2 %>% unique()
```

Correct values: energy_class
#####################

```{r}
# Check unique values
dt_refrigerator$energy_class %>% unique()

# OK
```


Correct values: energy_consumption
#####################
```{r}

# get the first 3 characters, typically it is a number meaning the annual energy consumption in kWh
# if it is smaller (or not a number) than 1 -> get the first 5 character
dt_refrigerator$energy_consumption <- ifelse(substr(dt_refrigerator$energy_consumption, 1, 3) < 1,
                            substr(dt_refrigerator$energy_consumption, 1, 5),
                            substr(dt_refrigerator$energy_consumption, 1, 3)
                            )

# in some case it contains "/" -> get the last 5 character
dt_refrigerator$energy_consumption <- ifelse(grepl("/",substr(dt_refrigerator$energy_consumption, 1, 5), fixed = TRUE),
                            str_sub(dt_refrigerator$energy_consumption, -5),
                            dt_refrigerator$energy_consumption 
                            )
# change decimal
dt_refrigerator$energy_consumption <- str_replace(dt_refrigerator$energy_consumption, ",", ".")

# change variable type
dt_refrigerator$energy_consumption <- as.numeric(dt_refrigerator$energy_consumption)

# if value < 5 -> it is a daily consumption data -> convert it to annual one
dt_refrigerator$energy_consumption <- ifelse(dt_refrigerator$energy_consumption < 5,
                                   dt_refrigerator$energy_consumption * 365,
                                   dt_refrigerator$energy_consumption
                                   )

# Round values
dt_refrigerator$energy_consumption <- round(dt_refrigerator$energy_consumption,0)
```

Correct values: guarantee_month
#####################

```{r}
# Check unique values
dt_refrigerator$guarantee_month %>% unique()

# OK
```

Correct values: colour
#####################

```{r}
# Check unique values
dt_refrigerator$colour %>% unique()

# Translate colours to English
dt_refrigerator[colour == "fehér", "colour"] <- "white"
dt_refrigerator[colour == "hófehér", "colour"] <- "white"
dt_refrigerator[colour == "üveg, fehér", "colour"] <- "white"

dt_refrigerator[colour == "Fekete, Inox", "colour"] <- "black"
dt_refrigerator[colour == "fekete", "colour"] <- "black"
dt_refrigerator[colour == "Fekete acél", "colour"] <- "black"
dt_refrigerator[colour == "matt fekete", "colour"] <- "black"
dt_refrigerator[colour == "fekete, rozsdamentes acél", "colour"] <- "black"

dt_refrigerator[colour == "Inox", "colour"] <- "grey"
dt_refrigerator[colour == "inox, króm", "colour"] <- "grey"
dt_refrigerator[colour == "inox, nemesacél, króm", "colour"] <- "grey"
dt_refrigerator[colour == "inox, króm, metál", "colour"] <- "grey"
dt_refrigerator[colour == "inox, metál", "colour"] <- "grey"
dt_refrigerator[colour == "inox, ezüst", "colour"] <- "grey"
dt_refrigerator[colour == "fehér, inox, ezüst", "colour"] <- "grey"
dt_refrigerator[colour == "inox, szürke", "colour"] <- "grey"
dt_refrigerator[colour == "ezüst oldalak + inox ajtó", "colour"] <- "grey"
dt_refrigerator[colour == "ezüst", "colour"] <- "grey"
dt_refrigerator[colour == "hamvas ezüst", "colour"] <- "grey"
dt_refrigerator[colour == "acélszürke", "colour"] <- "grey"
dt_refrigerator[colour == "Szürke", "colour"] <- "grey"
dt_refrigerator[colour == "szürke", "colour"] <- "grey"
dt_refrigerator[colour == "metál, szürke", "colour"] <- "grey"
dt_refrigerator[colour == "rozsdamentes acél", "colour"] <- "grey"
dt_refrigerator[colour == "ragyogó acél", "colour"] <- "grey"
dt_refrigerator[colour == "nemesacél", "colour"] <- "grey"

dt_refrigerator[colour == "Fekete, Szürke", "colour"] <- "black, grey"

dt_refrigerator[colour == "Antracit", "colour"] <- "anthracite"

dt_refrigerator[colour == "Bézs", "colour"] <- "beige"
dt_refrigerator[colour == "elefántcsont", "colour"] <- "beige"

dt_refrigerator[colour == "Bronz", "colour"] <- "bronze"
dt_refrigerator[colour == "kávé", "colour"] <- "bronze"

dt_refrigerator[colour == "Sárga", "colour"] <- "yellow"

dt_refrigerator[colour == "narancssárga", "colour"] <- "orange"
dt_refrigerator[colour == "Narancs", "colour"] <- "orange"

dt_refrigerator[colour == "Kék", "colour"] <- "blue"
dt_refrigerator[colour == "Türkiz", "colour"] <- "blue"

dt_refrigerator[colour == "Rózsaszín", "colour"] <- "pink"

dt_refrigerator[colour == "Piros", "colour"] <- "red"
dt_refrigerator[colour == "vörös", "colour"] <- "red"

dt_refrigerator[colour == "bordó", "colour"] <- "claret"

dt_refrigerator[colour == "Zöld", "colour"] <- "green"
dt_refrigerator[colour == "Szürke, Zöld", "colour"] <- "green, grey"

dt_refrigerator[colour == "csokoládé", "colour"] <- "chocolate"

dt_refrigerator$colour %>% unique()
```

Correct values: width_cm
#####################
```{r}

# if "cm" is included -> change it to ""
dt_refrigerator$width_cm <- str_replace(dt_refrigerator$width_cm, "cm", "")

# if space is included -> change it to ""
dt_refrigerator$width_cm <- str_replace(dt_refrigerator$width_cm, " ", "")

# change decimal
dt_refrigerator$width_cm <- str_replace(dt_refrigerator$width_cm, ",", ".")

# "mm" is included -> convert is to cm
dt_refrigerator$width_cm <- ifelse(grepl("mm", dt_refrigerator$width_cm,fixed = TRUE),
                        as.numeric(str_replace(dt_refrigerator$width_cm, "mm", "")) / 10,
                        dt_refrigerator$width_cm
                        )

# change variable type
dt_refrigerator$width_cm <- as.numeric(dt_refrigerator$width_cm)

```

Correct values: height_cm
#####################
```{r}

# if "cm" is included -> change it to ""
dt_refrigerator$height_cm <- str_replace(dt_refrigerator$height_cm, "cm", "")

# if "vm" is included (typo!) -> change it to ""
dt_refrigerator$height_cm <- str_replace(dt_refrigerator$height_cm, "vm", "")

# if space is included -> change it to ""
dt_refrigerator$height_cm <- str_replace(dt_refrigerator$height_cm, " ", "")

# change decimal
dt_refrigerator$height_cm <- str_replace(dt_refrigerator$height_cm, ",", ".")

# "mm" is included -> convert is to cm
dt_refrigerator$height_cm <- ifelse(grepl("mm", dt_refrigerator$height_cm,fixed = TRUE),
                        as.numeric(str_replace(dt_refrigerator$height_cm, "mm", "")) / 10,
                        dt_refrigerator$height_cm
                        )

# change variable type
dt_refrigerator$height_cm <- as.numeric(dt_refrigerator$height_cm)

```

Correct values: depth
#####################
```{r}
# if "cm" is included -> change it to ""
dt_refrigerator$depth_cm <- str_replace(dt_refrigerator$depth_cm, "cm", "")

# if "vm" is included (typo!) -> change it to ""
dt_refrigerator$depth_cm <- str_replace(dt_refrigerator$depth_cm, "vm", "")

# if space is included -> change it to ""
dt_refrigerator$depth_cm <- str_replace(dt_refrigerator$depth_cm, " ", "")

# change decimal
dt_refrigerator$depth_cm <- str_replace(dt_refrigerator$depth_cm, ",", ".")

# "mm" is included -> convert is to cm
dt_refrigerator$depth_cm <- ifelse(grepl("mm", dt_refrigerator$depth_cm,fixed = TRUE),
                        as.numeric(str_replace(dt_refrigerator$depth_cm, "mm", "")) / 10,
                        dt_refrigerator$depth_cm
                        )

# change variable type
dt_refrigerator$depth_cm <- as.numeric(dt_refrigerator$depth_cm)

```

Correct values: weight_kg
#####################
```{r}
test <- dt_refrigerator %>% select(weight_kg)
test[is.na(test$weig)==T,] %>% nrow()


# if "cm" is included -> change it to ""
dt_refrigerator$depth_cm <- str_replace(dt_refrigerator$depth_cm, "cm", "")

# if "vm" is included (typo!) -> change it to ""
dt_refrigerator$depth_cm <- str_replace(dt_refrigerator$depth_cm, "vm", "")

# if space is included -> change it to ""
dt_refrigerator$depth_cm <- str_replace(dt_refrigerator$depth_cm, " ", "")

# change decimal
dt_refrigerator$depth_cm <- str_replace(dt_refrigerator$depth_cm, ",", ".")

# "mm" is included -> convert is to cm
dt_refrigerator$depth_cm <- ifelse(grepl("mm", dt_refrigerator$depth_cm,fixed = TRUE),
                        as.numeric(str_replace(dt_refrigerator$depth_cm, "mm", "")) / 10,
                        dt_refrigerator$depth_cm
                        )

# change variable type
dt_refrigerator$depth_cm <- as.numeric(dt_refrigerator$depth_cm)

```